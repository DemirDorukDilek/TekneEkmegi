{% extends "kuryeBase.html" %}

{% block title %}Kurye Paneli Â· Tekne EkmeÄŸi{% endblock %}

{% block content %}
<div class="card courier-card">
    <h1>Kurye Paneli</h1>
    <p class="subtitle">HoÅŸ geldin, {{ kurye[1] if kurye else 'Kurye' }}!</p>

    {% if kurye %}
    <!-- KURYE BÄ°LGÄ°LERÄ° KARTI -->
    <section class="courier-info-panel">
        <h3 class="courier-section-title">Kurye Bilgileri</h3>
        <p class="courier-info-row"><strong>Ad Soyad:</strong> {{ kurye[1] }} {{ kurye[2] }}</p>
        <p class="courier-info-row"><strong>Telefon:</strong> {{ kurye[3] }}</p>
        <p class="courier-info-row" id="durum-text">
            <strong>Durum:</strong>
            <span id="durum-badge" class="badge {% if kurye[5] %}badge-working{% else %}badge-idle{% endif %}">
                {% if kurye[5] %}Ã‡alÄ±ÅŸÄ±yor{% else %}Ã‡alÄ±ÅŸmÄ±yor{% endif %}
            </span>
        </p>
        <p class="courier-location-text" id="konum-text">
            Konum alÄ±nÄ±yor...
        </p>
    </section>

    <!-- Ã‡ALIÅMA DURUMU BUTONU -->
    <button id="ise-basla-btn" class="btn btn-primary courier-toggle-btn" onclick="toggleCalisma()"
        data-working="{{ '1' if kurye[5] else '0' }}">
        {% if kurye[5] %}Ä°ÅŸi Bitir{% else %}Ä°ÅŸe BaÅŸla{% endif %}
    </button>

    {% if siparis %}
    <!-- AKTÄ°F SÄ°PARÄ°Å KUTUSU -->
    <section class="courier-active-order">
        <h2 class="courier-active-title">Aktif SipariÅŸ</h2>

        <div class="courier-block">
            <h3 class="courier-block-title">ğŸ“ Restoran</h3>
            <p class="courier-block-main"><strong>{{ siparis[14] }}</strong></p>
            <p class="courier-block-sub">{{ siparis[16] }}</p>
            <p class="courier-block-sub">Tel: {{ siparis[15] }}</p>
        </div>

        <div class="courier-block courier-block-divider">
            <h3 class="courier-block-title">ğŸ  Teslimat Adresi</h3>
            <p class="courier-block-main">
                <strong>{{ siparis[3] }} {{ siparis[4] }}</strong>
            </p>
            <p class="courier-block-sub">Tel: {{ siparis[5] }}</p>
            <p class="courier-block-sub">
                {{ siparis[8] }} Mah., {{ siparis[9] }} Cad., No: {{ siparis[10] }}, Daire: {{ siparis[11] }}
            </p>
            <p class="courier-block-sub">{{ siparis[7] }}, {{ siparis[6] }}</p>
        </div>

        <div class="courier-status-row">
            <p class="courier-status-text">
                SipariÅŸ Durumu:
                {% if siparis[1] == 'Cook' %}HazÄ±rlanÄ±yor
                {% elif siparis[1] == 'OnWay' %}Yolda
                {% elif siparis[1] == 'Arrived' %}Teslim Edildi
                {% else %}{{ siparis[1] }}
                {% endif %}
            </p>
        </div>

        <form action="/kurye/siparisTamamla" method="post" class="courier-complete-form">
            <input type="hidden" name="sparisNo" value="{{ siparis[0] }}">
            <button type="submit" class="btn btn-success">
                âœ… SipariÅŸi Teslim Et
            </button>
        </form>
    </section>
    {% else %}
    <!-- BEKLEYEN SÄ°PARÄ°ÅLER KUTUSU -->
    <section class="courier-waiting-orders">
        <h2 class="courier-waiting-title">ğŸ“¦ Bekleyen SipariÅŸler</h2>
        <p class="courier-waiting-subtitle">
            YakÄ±nÄ±nÄ±zdaki sipariÅŸleri kabul edebilirsiniz.
        </p>
        <div id="bekleyen-siparisler-liste" class="courier-waiting-list">
            <p class="courier-waiting-loading">YÃ¼kleniyor...</p>
        </div>
    </section>
    {% endif %}

    {% else %}
    <p class="courier-error-text">Kurye bilgileri yÃ¼klenemedi.</p>
    {% endif %}
</div>

<script>
    let koordinatIntervalId = null;
    let isWorking = {{ 'true' if kurye and kurye[5] else 'false' }};

    function toggleCalisma() {
        const btn = document.getElementById('ise-basla-btn');
        const currentState = btn.getAttribute('data-working');
        const newState = currentState === '1' ? '0' : '1';

        const formData = new FormData();
        formData.append('durum', newState);

        fetch('/kurye/iseBasla', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isWorking = data.isWorking;
                    btn.setAttribute('data-working', newState);
                    btn.textContent = newState === '1' ? 'Ä°ÅŸi Bitir' : 'Ä°ÅŸe BaÅŸla';

                    const badge = document.getElementById('durum-badge');
                    badge.textContent = newState === '1' ? 'Ã‡alÄ±ÅŸÄ±yor' : 'Ã‡alÄ±ÅŸmÄ±yor';
                    badge.classList.toggle('badge-working', newState === '1');
                    badge.classList.toggle('badge-idle', newState !== '1');

                    if (newState === '1') {
                        koordinatGondermeBaslat();
                    } else {
                        koordinatGondermeDurdur();
                    }

                    location.reload();
                } else {
                    alert('Durum deÄŸiÅŸtirilemedi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Bir hata oluÅŸtu.');
            });
    }

    function koordinatGondermeBaslat() {
        if (koordinatIntervalId) return;

        konumGuncelle();

        koordinatIntervalId = setInterval(() => {
            konumGuncelle();
        }, 30000);
    }

    function koordinatGondermeDurdur() {
        if (koordinatIntervalId) {
            clearInterval(koordinatIntervalId);
            koordinatIntervalId = null;
        }
    }

    function konumGuncelle() {
        if (!navigator.geolocation) {
            console.error('TarayÄ±cÄ±nÄ±z konum Ã¶zelliÄŸini desteklemiyor.');
            document.getElementById('konum-text').textContent = 'Konum Ã¶zelliÄŸi desteklenmiyor.';
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const x = position.coords.longitude;
                const y = position.coords.latitude;

                const formData = new FormData();
                formData.append('x', x);
                formData.append('y', y);

                fetch('/kurye/koordinatGuncelle', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const now = new Date().toLocaleTimeString('tr-TR');
                            document.getElementById('konum-text').textContent =
                                `Son konum gÃ¼ncellemesi: ${now} (Lat: ${y.toFixed(6)}, Lng: ${x.toFixed(6)})`;
                            console.log('Konum gÃ¼ncellendi:', x, y);
                        } else {
                            console.error('Konum gÃ¼ncellenemedi:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Konum gÃ¶nderme hatasÄ±:', error);
                    });
            },
            (error) => {
                console.error('Konum alÄ±namadÄ±:', error);
                document.getElementById('konum-text').textContent = 'Konum izni verilmedi veya alÄ±namadÄ±.';
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    if (isWorking) {
        koordinatGondermeBaslat();
    }

    // Bekleyen sipariÅŸleri yÃ¼kle
    function bekleyenSiparisleriYukle() {
        fetch('/kurye/bekleyenSiparisler', {
            method: 'GET'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.siparisler) {
                    const liste = document.getElementById('bekleyen-siparisler-liste');
                    if (data.siparisler.length === 0) {
                        liste.innerHTML = '<p class="courier-waiting-empty">Åu anda bekleyen sipariÅŸ yok.</p>';
                    } else {
                        let html = '';
                        data.siparisler.forEach(siparis => {
                            html += `
                        <div class="courier-order-card">
                            <div class="courier-order-card-body">
                                <p class="courier-order-id">SipariÅŸ #${siparis.sparisNo}</p>
                                <p class="courier-order-line">
                                    <strong>MÃ¼ÅŸteri:</strong> ${siparis.efendiName} ${siparis.efendiSurname}
                                </p>
                                <p class="courier-order-line">
                                    <strong>Restoran:</strong> ${siparis.restoranName}
                                </p>
                                <p class="courier-order-line">
                                    <strong>Adres:</strong> ${siparis.restoranAdres}
                                </p>
                                <p class="courier-order-distance">
                                    <strong>Mesafe:</strong> ~${siparis.mesafe} km
                                </p>
                            </div>
                            <form action="/kurye/siparisKabulEt" method="post">
                                <input type="hidden" name="sparisNo" value="${siparis.sparisNo}">
                                <button type="submit" class="btn btn-success">
                                    âœ… SipariÅŸi Kabul Et
                                </button>
                            </form>
                        </div>
                    `;
                        });
                        liste.innerHTML = html;
                    }
                }
            })
            .catch(error => {
                console.error('Bekleyen sipariÅŸler yÃ¼klenemedi:', error);
                document.getElementById('bekleyen-siparisler-liste').innerHTML =
                    '<p class="courier-error-text">SipariÅŸler yÃ¼klenemedi.</p>';
            });
    }

    {% if not siparis %}
    bekleyenSiparisleriYukle();
    setInterval(bekleyenSiparisleriYukle, 30000);
    {% endif %}

    window.addEventListener('beforeunload', () => {
        koordinatGondermeDurdur();
    });
</script>
{% endblock %}