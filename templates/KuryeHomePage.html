{% extends "base.html" %}

{% block title %}Kurye Paneli Â· Tekne EkmeÄŸi{% endblock %}

{% block content %}
<div class="card">
    <h1>Kurye Paneli</h1>
    <p class="subtitle">HoÅŸ geldin, {{ kurye[1] if kurye else 'Kurye' }}!</p>

    {% if kurye %}
    <div style="background: #1e140c; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
        <h3 style="color: #d8a451; font-size: 16px; margin-bottom: 8px;">Kurye Bilgileri</h3>
        <p style="margin: 4px 0;"><strong>Ad Soyad:</strong> {{ kurye[1] }} {{ kurye[2] }}</p>
        <p style="margin: 4px 0;"><strong>Telefon:</strong> {{ kurye[3] }}</p>
        <p style="margin: 4px 0;" id="durum-text">
            <strong>Durum:</strong>
            <span id="durum-badge" class="badge" style="padding: 4px 12px; border-radius: 4px; font-weight: 600;">
                {% if kurye[5] %}Ã‡alÄ±ÅŸÄ±yor{% else %}Ã‡alÄ±ÅŸmÄ±yor{% endif %}
            </span>
        </p>
        <p style="margin: 4px 0; font-size: 12px; color: #bfa78a;" id="konum-text">Konum alÄ±nÄ±yor...</p>
    </div>

    <button
        id="ise-basla-btn"
        class="btn btn-primary"
        onclick="toggleCalisma()"
        data-working="{{ '1' if kurye[5] else '0' }}"
        style="width: 100%; font-size: 16px; padding: 12px;">
        {% if kurye[5] %}Ä°ÅŸi Bitir{% else %}Ä°ÅŸe BaÅŸla{% endif %}
    </button>

    {% if siparis %}
    <div style="background: #0f2816; padding: 16px; border-radius: 8px; margin-top: 24px; border: 2px solid #4ade80;">
        <h2 style="color: #4ade80; font-size: 18px; margin-bottom: 12px;">Aktif SipariÅŸ</h2>

        <div style="margin-bottom: 16px;">
            <h3 style="color: #d8a451; font-size: 14px; margin-bottom: 8px;">ğŸ“ Restoran</h3>
            <p style="margin: 4px 0; font-size: 14px;"><strong>{{ siparis[14] }}</strong></p>
            <p style="margin: 4px 0; font-size: 12px; color: #bfa78a;">{{ siparis[16] }}</p>
            <p style="margin: 4px 0; font-size: 12px; color: #bfa78a;">Tel: {{ siparis[15] }}</p>
        </div>

        <div style="border-top: 1px solid #4ade80; padding-top: 12px;">
            <h3 style="color: #d8a451; font-size: 14px; margin-bottom: 8px;">ğŸ  Teslimat Adresi</h3>
            <p style="margin: 4px 0; font-size: 14px;"><strong>{{ siparis[3] }} {{ siparis[4] }}</strong></p>
            <p style="margin: 4px 0; font-size: 12px; color: #bfa78a;">Tel: {{ siparis[5] }}</p>
            <p style="margin: 4px 0; font-size: 12px; color: #bfa78a;">
                {{ siparis[8] }} Mah., {{ siparis[9] }} Cad., No: {{ siparis[10] }}, Daire: {{ siparis[11] }}
            </p>
            <p style="margin: 4px 0; font-size: 12px; color: #bfa78a;">{{ siparis[7] }}, {{ siparis[6] }}</p>
        </div>

        <div style="margin-top: 16px;">
            <p style="font-size: 12px; color: #4ade80; font-weight: 600;">
                SipariÅŸ Durumu:
                {% if siparis[1] == 'Cook' %}HazÄ±rlanÄ±yor
                {% elif siparis[1] == 'OnWay' %}Yolda
                {% elif siparis[1] == 'Arrived' %}Teslim Edildi
                {% else %}{{ siparis[1] }}
                {% endif %}
            </p>
        </div>

        <form action="/kurye/siparisTamamla" method="post" style="margin-top: 16px;">
            <input type="hidden" name="sparisNo" value="{{ siparis[0] }}">
            <button type="submit" class="btn btn-success" style="width: 100%; background: #4ade80; color: #000;">
                âœ… SipariÅŸi Teslim Et
            </button>
        </form>
    </div>
    {% else %}
    <div style="background: #1e140c; padding: 16px; border-radius: 8px; margin-top: 24px;">
        <h2 style="color: #d8a451; font-size: 18px; margin-bottom: 12px;">ğŸ“¦ Bekleyen SipariÅŸler</h2>
        <p style="color: #bfa78a; font-size: 12px; margin-bottom: 12px;">YakÄ±nÄ±nÄ±zdaki sipariÅŸleri kabul edebilirsiniz.</p>
        <div id="bekleyen-siparisler-liste">
            <p style="color: #bfa78a; font-size: 14px; text-align: center;">YÃ¼kleniyor...</p>
        </div>
    </div>
    {% endif %}

    {% else %}
    <p style="color: #ff6b6b; margin-top: 16px;">Kurye bilgileri yÃ¼klenemedi.</p>
    {% endif %}
</div>

<script>
let koordinatIntervalId = null;
let isWorking = {{ 'true' if kurye and kurye[5] else 'false' }};

function toggleCalisma() {
    const btn = document.getElementById('ise-basla-btn');
    const currentState = btn.getAttribute('data-working');
    const newState = currentState === '1' ? '0' : '1';

    const formData = new FormData();
    formData.append('durum', newState);

    fetch('/kurye/iseBasla', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            isWorking = data.isWorking;
            btn.setAttribute('data-working', newState);
            btn.textContent = newState === '1' ? 'Ä°ÅŸi Bitir' : 'Ä°ÅŸe BaÅŸla';

            const badge = document.getElementById('durum-badge');
            badge.textContent = newState === '1' ? 'Ã‡alÄ±ÅŸÄ±yor' : 'Ã‡alÄ±ÅŸmÄ±yor';
            badge.style.background = newState === '1' ? '#4ade80' : '#6b7280';
            badge.style.color = newState === '1' ? '#000' : '#fff';

            if (newState === '1') {
                koordinatGondermeBaslat();
            } else {
                koordinatGondermeDurdur();
            }

            location.reload();
        } else {
            alert('Durum deÄŸiÅŸtirilemedi: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Bir hata oluÅŸtu.');
    });
}

function koordinatGondermeBaslat() {
    if (koordinatIntervalId) return;

    konumGuncelle();

    koordinatIntervalId = setInterval(() => {
        konumGuncelle();
    }, 30000);
}

function koordinatGondermeDurdur() {
    if (koordinatIntervalId) {
        clearInterval(koordinatIntervalId);
        koordinatIntervalId = null;
    }
}

function konumGuncelle() {
    if (!navigator.geolocation) {
        console.error('TarayÄ±cÄ±nÄ±z konum Ã¶zelliÄŸini desteklemiyor.');
        document.getElementById('konum-text').textContent = 'Konum Ã¶zelliÄŸi desteklenmiyor.';
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const x = position.coords.longitude;
            const y = position.coords.latitude;

            const formData = new FormData();
            formData.append('x', x);
            formData.append('y', y);

            fetch('/kurye/koordinatGuncelle', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const now = new Date().toLocaleTimeString('tr-TR');
                    document.getElementById('konum-text').textContent =
                        `Son konum gÃ¼ncellemesi: ${now} (Lat: ${y.toFixed(6)}, Lng: ${x.toFixed(6)})`;
                    console.log('Konum gÃ¼ncellendi:', x, y);
                } else {
                    console.error('Konum gÃ¼ncellenemedi:', data.message);
                }
            })
            .catch(error => {
                console.error('Konum gÃ¶nderme hatasÄ±:', error);
            });
        },
        (error) => {
            console.error('Konum alÄ±namadÄ±:', error);
            document.getElementById('konum-text').textContent = 'Konum izni verilmedi veya alÄ±namadÄ±.';
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

if (isWorking) {
    koordinatGondermeBaslat();
}

// Bekleyen sipariÅŸleri yÃ¼kle
function bekleyenSiparisleriYukle() {
    fetch('/kurye/bekleyenSiparisler', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.siparisler) {
            const liste = document.getElementById('bekleyen-siparisler-liste');
            if (data.siparisler.length === 0) {
                liste.innerHTML = '<p style="color: #bfa78a; font-size: 14px; text-align: center;">Åu anda bekleyen sipariÅŸ yok.</p>';
            } else {
                let html = '';
                data.siparisler.forEach(siparis => {
                    html += `
                        <div style="background: #2d1f0f; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #d8a451;">
                            <div style="margin-bottom: 8px;">
                                <p style="font-size: 14px; font-weight: 600; color: #d8a451;">SipariÅŸ #${siparis.sparisNo}</p>
                                <p style="font-size: 12px; color: #bfa78a; margin: 4px 0;">
                                    <strong>MÃ¼ÅŸteri:</strong> ${siparis.efendiName} ${siparis.efendiSurname}
                                </p>
                                <p style="font-size: 12px; color: #bfa78a; margin: 4px 0;">
                                    <strong>Restoran:</strong> ${siparis.restoranName}
                                </p>
                                <p style="font-size: 12px; color: #bfa78a; margin: 4px 0;">
                                    <strong>Adres:</strong> ${siparis.restoranAdres}
                                </p>
                                <p style="font-size: 12px; color: #4ade80; margin: 4px 0;">
                                    <strong>Mesafe:</strong> ~${siparis.mesafe} km
                                </p>
                            </div>
                            <form action="/kurye/siparisKabulEt" method="post">
                                <input type="hidden" name="sparisNo" value="${siparis.sparisNo}">
                                <button type="submit" class="btn btn-success" style="width: 100%; padding: 8px; font-size: 14px;">
                                    âœ… SipariÅŸi Kabul Et
                                </button>
                            </form>
                        </div>
                    `;
                });
                liste.innerHTML = html;
            }
        }
    })
    .catch(error => {
        console.error('Bekleyen sipariÅŸler yÃ¼klenemedi:', error);
        document.getElementById('bekleyen-siparisler-liste').innerHTML =
            '<p style="color: #ff6b6b; font-size: 14px; text-align: center;">SipariÅŸler yÃ¼klenemedi.</p>';
    });
}

// EÄŸer aktif sipariÅŸ yoksa bekleyen sipariÅŸleri yÃ¼kle
{% if not siparis %}
bekleyenSiparisleriYukle();
// Her 30 saniyede bir yenile
setInterval(bekleyenSiparisleriYukle, 30000);
{% endif %}

window.addEventListener('beforeunload', () => {
    koordinatGondermeDurdur();
});
</script>

<style>
.badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 4px;
    font-weight: 600;
}

.btn-success {
    background: #4ade80;
    color: #000;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-success:hover {
    background: #22c55e;
    transform: translateY(-2px);
}
</style>
{% endblock %}
