{% extends "base.html" %}

{% block title %}Sepetim · Tekne Ekmeği{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px;">
    <h1>Sepetim</h1>
    <p class="subtitle">Sipariş vermeden önce sepetini kontrol et.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash-message flash-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if sepet_urunler and sepet_urunler|length > 0 %}
        {# Restorana göre grupla #}
        {% set restoran_map = {} %}
        {% for urun in sepet_urunler %}
            {# urun: (yemekID, yemekAdi, fiyat, adet, restoranAdi, restoranID) #}
            {% set restoranID = urun[5] %}
            {% set restoranAdi = urun[4] %}
            
            {% if restoranID not in restoran_map %}
                {% set _ = restoran_map.update({restoranID: {'ad': restoranAdi, 'urunler': [], 'toplam': 0}}) %}
            {% endif %}
            
            {% set _ = restoran_map[restoranID]['urunler'].append(urun) %}
            {% set toplam = restoran_map[restoranID]['toplam'] + (urun[2] * urun[3]) %}
            {% set _ = restoran_map[restoranID].update({'toplam': toplam}) %}
        {% endfor %}

        {# Her restoran için göster #}
        {% for restoranID, data in restoran_map.items() %}
        <div style="margin-bottom: 24px; padding: 16px; background: #faf8f2; border-radius: 10px; border: 1px solid #dcd6c8;">
            <h3 style="margin: 0 0 12px 0; color: #23304a; font-size: 16px;">{{ data['ad'] }}</h3>
            
            {% for urun in data['urunler'] %}
            {# urun: (yemekID, yemekAdi, fiyat, adet, restoranAdi, restoranID) #}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px;">
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #2d2d2d;">{{ urun[1] }}</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">
                        {{ "%.2f"|format(urun[2]) }} ₺ × {{ urun[3] }} = {{ "%.2f"|format(urun[2] * urun[3]) }} ₺
                    </div>
                </div>
                

                <form action="/sepeteEkle" method="post">
                    <input type="hidden" name="yemekID" value="{{ urun[0] }}">
                    <input type="hidden" name="restoranID" value="{{ 'sepet' }}">
                    <button type="submit" class="btn btn-sm" style="background: #4de35e; color: white; padding: 6px 12px; margin: 0; margin-right: 10px;">
                        +
                    </button>
                </form>
                <form action="/sepeteEkle" method="post">
                    <input type="hidden" name="yemekID" value="{{ urun[0] }}">
                    <input type="hidden" name="restoranID" value="{{ 'sepet' }}">
                    <input type="hidden" name="adet" value="{{  -1 }}">
                    <button type="submit" class="btn btn-sm" style="background: #e34d4d; color: white; padding: 6px 12px; margin: 0; margin-right: 10px;">
                        -
                    </button>
                </form>
                <form action="/sepettenSil" method="post">
                    <input type="hidden" name="yemekID" value="{{ urun[0] }}">
                    <button type="submit" class="btn btn-sm" style="background: #e34d4d; color: white; padding: 6px 12px; margin: 0;">
                        Sil
                    </button>
                </form>
            </div>
            {% endfor %}
            
            <div style="text-align: right; margin-top: 12px; padding-top: 12px; border-top: 1px solid #dcd6c8;">
                <span style="font-weight: 600; color: #23304a;">Toplam: </span>
                <span style="font-weight: 700; color: #d8a451; font-size: 18px;">{{ "%.2f"|format(data['toplam']) }} ₺</span>
            </div>
        </div>
        {% endfor %}

        <div style="margin-top: 20px; display: flex; gap: 8px;">
            <form action="/HomePage" method="get" style="flex: 1;">
                <button type="submit" class="btn btn-secondary">Alışverişe Devam</button>
            </form>
            
            <form action="/siparisOlustur" method="post" style="flex: 1;">
                <button type="submit" class="btn btn-primary">Sipariş Ver</button>
            </form>
        </div>
    {% else %}
        <p style="color: #6b7280; margin-top: 12px; font-size: 14px;">Sepetiniz boş.</p>
        
        <form action="/HomePage" method="get" style="margin-top: 16px;">
            <button type="submit" class="btn btn-primary">Restoranları Gör</button>
        </form>
    {% endif %}
</div>
{% endblock %}