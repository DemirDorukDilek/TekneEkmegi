{% extends "base.html" %}

{% block title %}Sepetim · Tekne Ekmeği{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px;">
    <h1>Sepetim</h1>
    <p class="subtitle">Sipariş vermeden önce sepetini kontrol et.</p>

    {% if sepet_urunler and sepet_urunler|length > 0 %}
        {# Restorana göre grupla #}
        {% set restoran_map = {} %}
        {% for urun in sepet_urunler %}
            {# urun: (yemekID, yemekAdi, fiyat, adet, restoranAdi, restoranID) #}
            {% set restoranID = urun[5] %}
            {% set restoranAdi = urun[4] %}
            
            {% if restoranID not in restoran_map %}
                {% set _ = restoran_map.update({restoranID: {'ad': restoranAdi, 'urunler': [], 'toplam': 0}}) %}
            {% endif %}
            
            {% set _ = restoran_map[restoranID]['urunler'].append(urun) %}
            {% set toplam = restoran_map[restoranID]['toplam'] + (urun[2] * urun[3]) %}
            {% set _ = restoran_map[restoranID].update({'toplam': toplam}) %}
        {% endfor %}

        {# Her restoran için göster #}
        {% for restoranID, data in restoran_map.items() %}
        <div style="margin-bottom: 24px; padding: 16px; background: #faf8f2; border-radius: 10px; border: 1px solid #dcd6c8;">
            <h3 style="margin: 0 0 12px 0; color: #23304a; font-size: 16px;">{{ data['ad'] }}</h3>
            
            {% for urun in data['urunler'] %}
            {# urun: (yemekID, yemekAdi, fiyat, adet, restoranAdi, restoranID) #}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px;">
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #2d2d2d;">{{ urun[1] }}</div>
                    <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">
                        {{ "%.2f"|format(urun[2]) }} ₺ × {{ urun[3] }} = {{ "%.2f"|format(urun[2] * urun[3]) }} ₺
                    </div>
                </div>
                

                <form action="/sepeteEkle" method="post">
                    <input type="hidden" name="yemekID" value="{{ urun[0] }}">
                    <input type="hidden" name="restoranID" value="{{ 'sepet' }}">
                    <button type="submit" class="btn btn-sm" style="background: #4de35e; color: white; padding: 6px 12px; margin: 0; margin-right: 10px;">
                        +
                    </button>
                </form>
                <form action="/sepeteEkle" method="post">
                    <input type="hidden" name="yemekID" value="{{ urun[0] }}">
                    <input type="hidden" name="restoranID" value="{{ 'sepet' }}">
                    <input type="hidden" name="adet" value="{{  -1 }}">
                    <button type="submit" class="btn btn-sm" style="background: #e34d4d; color: white; padding: 6px 12px; margin: 0; margin-right: 10px;">
                        -
                    </button>
                </form>
                <form action="/sepettenSil" method="post">
                    <input type="hidden" name="yemekID" value="{{ urun[0] }}">
                    <button type="submit" class="btn btn-sm" style="background: #e34d4d; color: white; padding: 6px 12px; margin: 0;">
                        Sil
                    </button>
                </form>
            </div>
            {% endfor %}
            
            <div style="text-align: right; margin-top: 12px; padding-top: 12px; border-top: 1px solid #dcd6c8;">
                <span style="font-weight: 600; color: #23304a;">Toplam: </span>
                <span style="font-weight: 700; color: #d8a451; font-size: 18px;">{{ "%.2f"|format(data['toplam']) }} ₺</span>
            </div>
        </div>
        {% endfor %}

        <form action="/siparisOlustur" method="post" style="margin-top: 20px;" id="siparisForm">
            <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #dcd6c8;">
                <label style="display: block; font-weight: 600; color: #23304a; margin-bottom: 12px; font-size: 14px;">
                    Ödeme Yöntemi:
                </label>
                <div style="display: flex; gap: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="odemeYontemi" value="nakit" checked style="margin-right: 8px; cursor: pointer;" onchange="toggleKartBilgileri()">
                        <span style="color: #2d2d2d; font-size: 14px;">Nakit</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="odemeYontemi" value="krediKarti" style="margin-right: 8px; cursor: pointer;" onchange="toggleKartBilgileri()">
                        <span style="color: #2d2d2d; font-size: 14px;">Kredi Kartı</span>
                    </label>
                </div>
            </div>

            <div id="kartBilgileri" style="display: none; margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px; border: 1px solid #dcd6c8;">
                <label style="display: block; font-weight: 600; color: #23304a; margin-bottom: 12px; font-size: 14px;">
                    Kart Bilgileri:
                </label>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">Kart Numarası:</label>
                    <input type="text" name="kartNo" id="kartNo" placeholder="1234 5678 9012 3456" maxlength="19"
                           style="width: 100%; padding: 8px 12px; border: 1px solid #dcd6c8; border-radius: 6px; font-size: 14px;">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">Kart Sahibi Adı:</label>
                    <input type="text" name="kartSahibi" id="kartSahibi" placeholder="AD SOYAD"
                           style="width: 100%; padding: 8px 12px; border: 1px solid #dcd6c8; border-radius: 6px; font-size: 14px; text-transform: uppercase;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">Son Kullanma Tarihi:</label>
                        <input type="text" name="sonKullanma" id="sonKullanma" placeholder="AA/YY" maxlength="5"
                               style="width: 100%; padding: 8px 12px; border: 1px solid #dcd6c8; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; color: #6b7280; margin-bottom: 4px;">CVV:</label>
                        <input type="text" name="cvv" id="cvv" placeholder="123" maxlength="3"
                               style="width: 100%; padding: 8px 12px; border: 1px solid #dcd6c8; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 8px;">
                <a href="/HomePage" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; display: inline-block;">
                    Alışverişe Devam
                </a>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Sipariş Ver</button>
            </div>
        </form>

        <script>
        function toggleKartBilgileri() {
            const krediKartiRadio = document.querySelector('input[name="odemeYontemi"][value="krediKarti"]');
            const kartBilgileriDiv = document.getElementById('kartBilgileri');
            const kartInputlar = ['kartNo', 'kartSahibi', 'sonKullanma', 'cvv'];

            if (krediKartiRadio.checked) {
                kartBilgileriDiv.style.display = 'block';
                // Kredi kartı seçilince alanları zorunlu yap
                kartInputlar.forEach(id => {
                    document.getElementById(id).required = true;
                });
            } else {
                kartBilgileriDiv.style.display = 'none';
                // Nakit seçilince alanları zorunlu olmaktan çıkar ve temizle
                kartInputlar.forEach(id => {
                    const input = document.getElementById(id);
                    input.required = false;
                    input.value = '';
                });
            }
        }

        // Kart numarası formatla (her 4 hanede bir boşluk)
        document.addEventListener('DOMContentLoaded', function() {
            const kartNoInput = document.getElementById('kartNo');
            if (kartNoInput) {
                kartNoInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });
            }

            // Son kullanma tarihi formatla (AA/YY)
            const sonKullanmaInput = document.getElementById('sonKullanma');
            if (sonKullanmaInput) {
                sonKullanmaInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.slice(0, 2) + '/' + value.slice(2, 4);
                    }
                    e.target.value = value;
                });
            }

            // CVV sadece rakam
            const cvvInput = document.getElementById('cvv');
            if (cvvInput) {
                cvvInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            }
        });
        </script>
    {% else %}
        <p style="color: #6b7280; margin-top: 12px; font-size: 14px;">Sepetiniz boş.</p>
        
        <form action="/HomePage" method="get" style="margin-top: 16px;">
            <button type="submit" class="btn btn-primary">Restoranları Gör</button>
        </form>
    {% endif %}
</div>
{% endblock %}